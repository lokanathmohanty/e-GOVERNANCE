{% extends 'base_bootstrap.html' %}
{% load static %}

{% block title %}Department Contact Messages | Admin Panel{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h3 fw-bold text-gray-800">Department Inbox</h1>
            <p class="text-muted">Manage enquiries from the "Contact Us" page.</p>
        </div>
        <div class="badge bg-primary fs-6">
            {{ messages.count }} Total Messages
        </div>
    </div>

    <!-- Stats Cards -->
    <div class="row g-4 mb-5 stagger-container">
        <div class="col-md-3 stagger-item">
            <div class="card border-0 shadow-premium h-100 rounded-4 overflow-hidden">
                <div class="card-body p-4 d-flex align-items-center gap-3">
                    <div class="bg-primary bg-opacity-10 p-3 rounded-4 text-primary">
                        <i class="bi bi-envelope-paper-fill fs-3"></i>
                    </div>
                    <div>
                        <h6 class="text-uppercase fw-black text-muted opacity-50 mb-1"
                            style="font-size: 0.65rem; letter-spacing: 1px;">TOTAL ENQUIRIES</h6>
                        <h2 class="mb-0 fw-black text-dark">{{ messages_list.count }}</h2>
                    </div>
                </div>
                <div class="bg-primary" style="height: 4px; width: 100%; opacity: 0.2;"></div>
            </div>
        </div>
        <div class="col-md-3 stagger-item">
            <div class="card border-0 shadow-premium h-100 rounded-4 overflow-hidden">
                <div class="card-body p-4 d-flex align-items-center gap-3">
                    <div class="bg-warning bg-opacity-10 p-3 rounded-4 text-warning">
                        <i class="bi bi-clock-history fs-3"></i>
                    </div>
                    <div>
                        <h6 class="text-uppercase fw-black text-muted opacity-50 mb-1"
                            style="font-size: 0.65rem; letter-spacing: 1px;">PENDING REPLY</h6>
                        <h2 class="mb-0 fw-black text-dark">{{ unread_count }}</h2>
                    </div>
                </div>
                <div class="bg-warning" style="height: 4px; width: 100%; opacity: 0.2;"></div>
            </div>
        </div>
        <div class="col-md-3 stagger-item">
            <div class="card border-0 shadow-premium h-100 rounded-4 overflow-hidden">
                <div class="card-body p-4 d-flex align-items-center gap-3">
                    <div class="bg-success bg-opacity-10 p-3 rounded-4 text-success">
                        <i class="bi bi-check-circle-fill fs-3"></i>
                    </div>
                    <div>
                        <h6 class="text-uppercase fw-black text-muted opacity-50 mb-1"
                            style="font-size: 0.65rem; letter-spacing: 1px;">RESOLVED</h6>
                        <h2 class="mb-0 fw-black text-dark">{{ resolved_count }}</h2>
                    </div>
                </div>
                <div class="bg-success" style="height: 4px; width: 100%; opacity: 0.2;"></div>
            </div>
        </div>
    </div>

    <div class="card border-0 shadow-premium rounded-4 overflow-hidden reveal">
        <div
            class="card-header bg-white py-4 px-4 border-bottom border-light d-flex align-items-center justify-content-between">
            <h5 class="mb-0 fw-black text-dark uppercase tracking-tight"><i class="bi bi-list-ul text-primary me-2"></i>
                Recent Enquiries</h5>
            <div class="dropdown">
                <button class="btn btn-sm btn-light border rounded-pill px-3 fw-bold" type="button"
                    data-bs-toggle="dropdown">
                    <i class="bi bi-filter me-1"></i> Filter
                </button>
                <ul class="dropdown-menu dropdown-menu-end shadow-lg border-0">
                    <li><a class="dropdown-item" href="?status=all">All Messages</a></li>
                    <li><a class="dropdown-item" href="?status=pending">Pending Only</a></li>
                    <li><a class="dropdown-item" href="?status=resolved">Resolved Only</a></li>
                </ul>
            </div>
        </div>
        <div class="table-responsive">
            <table class="table table-hover align-middle mb-0">
                <thead class="bg-light border-bottom">
                    <tr class="text-uppercase small fw-black tracking-widest text-muted">
                        <th scope="col" class="ps-4 py-3">Status</th>
                        <th scope="col" class="py-3">Sender</th>
                        <th scope="col" class="py-3">Subject</th>
                        <th scope="col" class="py-3">Department</th>
                        <th scope="col" class="py-3">Date</th>
                        <th scope="col" class="text-end pe-4 py-3">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for msg in messages_list %}
                    <tr class="{% if not msg.is_resolved %}fw-bold bg-light bg-opacity-25{% endif %}">
                        <td class="ps-4">
                            {% if msg.is_resolved %}
                            <span class="badge bg-success bg-opacity-10 text-success rounded-pill px-3">Resolved</span>
                            {% else %}
                            <span class="badge bg-warning bg-opacity-10 text-warning rounded-pill px-3">Pending</span>
                            {% endif %}
                        </td>
                        <td>
                            <div class="d-flex align-items-center gap-2">
                                <div class="avatar bg-primary text-white rounded-circle d-flex align-items-center justify-content-center"
                                    style="width: 32px; height: 32px; font-size: 14px;">
                                    {{ msg.name|slice:":1"|upper }}
                                </div>
                                <div>
                                    <div class="text-dark">{{ msg.name }}</div>
                                    <div class="text-muted small">{{ msg.email }}</div>
                                </div>
                            </div>
                        </td>
                        <td>{{ msg.subject|truncatechars:40 }}</td>
                        <td>
                            {% if msg.department %}
                            <span class="badge bg-secondary bg-opacity-10 text-secondary">{{
                                msg.department.department_name }}</span>
                            {% else %}
                            <span class="badge bg-light text-muted">General</span>
                            {% endif %}
                        </td>
                        <td class="text-muted small">{{ msg.created_at|date:"M d, Y" }}</td>
                        <td class="text-end pe-4">
                            <button type="button" class="btn btn-sm btn-outline-primary rounded-pill px-3"
                                data-bs-toggle="modal" data-bs-target="#replyModal{{ msg.id }}">
                                <i class="bi bi-reply-fill me-1"></i> Reply
                            </button>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="6" class="text-center py-5 text-muted">
                            <i class="bi bi-inbox fs-1 d-block mb-3 opacity-25"></i>
                            No messages found.
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}

{% block modals %}
{% for msg in messages_list %}
<!-- Reply Modal for {{ msg.name }} -->
<div class="modal fade" id="replyModal{{ msg.id }}" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg">
            <form method="POST" action="{% url 'mis:reply_contact' msg.id %}">
                {% csrf_token %}
                <div class="modal-header bg-primary text-white border-bottom-0">
                    <h5 class="modal-title fw-bold">Reply to {{ msg.name }}</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                        aria-label="Close"></button>
                </div>
                <div class="modal-body p-4">
                    <!-- Original Message Context -->
                    <div class="bg-light p-4 rounded-4 mb-4 border-0">
                        <div class="d-flex align-items-center gap-2 mb-2">
                            <span class="badge bg-primary-soft text-primary text-uppercase"
                                style="font-size: 0.65rem;">Original Enquiry</span>
                            <small class="text-muted">{{ msg.created_at|date:"M d, Y H:i" }}</small>
                        </div>
                        <p class="mb-0 text-dark font-medium">"{{ msg.message }}"</p>
                        {% if msg.attachment %}
                        <div class="mt-3">
                            <a href="{{ msg.attachment.url }}" target="_blank"
                                class="btn btn-sm btn-outline-secondary rounded-pill">
                                <i class="bi bi-paperclip"></i> View Attachment
                            </a>
                        </div>
                        {% endif %}
                    </div>

                    <div class="mb-4">
                        <label class="form-label fw-black small text-uppercase text-muted tracking-widest mb-2"
                            style="font-size: 0.7rem;">Your Response</label>
                        <textarea name="reply_message" class="form-control border-light shadow-sm" rows="6"
                            placeholder="Type a professional response..." required
                            style="border-radius: 12px; resize: none;"></textarea>
                    </div>

                    <div class="card bg-warning bg-opacity-10 border-0 rounded-4">
                        <div class="card-body p-3">
                            <div class="form-check form-switch mb-0">
                                <input class="form-check-input" type="checkbox" name="mark_resolved"
                                    id="resolve{{ msg.id }}" checked>
                                <label class="form-check-label small fw-bold text-dark" for="resolve{{ msg.id }}">
                                    Mark as resolved after sending reply
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer border-top-0 bg-light p-3">
                    <button type="button" class="btn btn-link text-muted text-decoration-none fw-bold"
                        data-bs-dismiss="modal">Discard Changes</button>
                    <button type="submit" class="btn btn-primary px-5 py-2 fw-bold rounded-pill shadow-sm">
                        <i class="bi bi-send-fill me-2"></i> Send Message
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endfor %}
{% endblock %}