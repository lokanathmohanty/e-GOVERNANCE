{% extends 'base_bootstrap.html' %}
{% block title %}Book Appointment | e-Gov{% endblock %}
{% block content %}
<div class="row justify-content-center py-5 reveal">
    <div class="col-lg-8">
        <div class="card card-premium shadow-premium border-0 overflow-hidden">
            <div class="card-header bg-primary text-white p-5 border-0 position-relative overflow-hidden">
                <div class="position-absolute top-0 end-0 p-4 opacity-10">
                    <i class="bi bi-calendar-check" style="font-size: 8rem;"></i>
                </div>
                <div class="relative z-10">
                    <h2 class="mb-2 fw-black tracking-tight uppercase">Visit Scheduler</h2>
                    <p class="mb-0 opacity-75 font-medium">Reserve a priority slot at your local government service
                        center.</p>
                </div>
            </div>
            <div class="card-body p-5 bg-white">
                <form method="POST" class="space-y-6">
                    {% csrf_token %}
                    <div class="row g-4">
                        <div class="col-md-6">
                            <label class="form-premium-label">Division / Department</label>
                            <div class="position-relative">
                                <select name="department" id="deptSelect" class="form-premium-control appearance-none"
                                    required onchange="filterCenters()">
                                    <option value="">Select Department</option>
                                    {% for d in departments %}
                                    <option value="{{ d.id }}">{{ d.department_name }}</option>
                                    {% endfor %}
                                </select>
                                <i
                                    class="bi bi-chevron-down position-absolute top-50 end-0 translate-middle-y me-3 text-muted pointer-events-none"></i>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <label class="form-premium-label">Service Center</label>
                            <div class="position-relative">
                                <select name="center" id="centerSelect" class="form-premium-control appearance-none"
                                    required>
                                    <option value="">Select Department First</option>
                                    {% for c in centers %}
                                    <option value="{{ c.id }}" data-dept="{{ c.department.id }}">{{ c.name }}</option>
                                    {% endfor %}
                                </select>
                                <i
                                    class="bi bi-chevron-down position-absolute top-50 end-0 translate-middle-y me-3 text-muted pointer-events-none"></i>
                            </div>
                        </div>

                        <div class="col-12">
                            <label class="form-premium-label">Select Service (Optional)</label>
                            <select name="service" class="form-premium-control appearance-none">
                                <option value="">General Inquiry / Guidance</option>
                                {% for s in services %}
                                <option value="{{ s.id }}">{{ s.service_name }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="col-md-6">
                            <label class="form-premium-label">Appointment Date</label>
                            <input type="date" name="date" class="form-premium-control" required min="2024-01-01">
                        </div>

                        <div class="col-md-6">
                            <label class="form-premium-label">Preferred Time Slot</label>
                            <div class="position-relative">
                                <select name="time_slot" class="form-premium-control appearance-none" required>
                                    <option value="10:00 AM - 10:30 AM">10:00 AM - 10:30 AM (Early)</option>
                                    <option value="10:30 AM - 11:00 AM">10:30 AM - 11:00 AM</option>
                                    <option value="11:00 AM - 11:30 AM">11:00 AM - 11:30 AM</option>
                                    <option value="11:30 AM - 12:00 PM">11:30 AM - 12:00 PM</option>
                                    <option value="02:00 PM - 02:30 PM">02:00 PM - 02:30 PM (Post-Lunch)</option>
                                </select>
                                <i
                                    class="bi bi-clock position-absolute top-50 end-0 translate-middle-y me-3 text-muted pointer-events-none"></i>
                            </div>
                        </div>
                    </div>

                    <div class="pt-4">
                        <button type="submit"
                            class="btn-premium btn-premium-primary w-100 py-4 shadow-lg uppercase tracking-widest fw-black">
                            Confirm Secure Booking
                        </button>
                        <p class="text-center text-muted small mt-4">
                            <i class="bi bi-info-circle"></i> Please arrive 15 minutes before your scheduled slot with
                            valid ID proof.
                        </p>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
    function filterCenters() {
        const deptId = document.getElementById('deptSelect').value;
        const centerSelect = document.getElementById('centerSelect');
        const options = centerSelect.querySelectorAll('option');

        // Reset selection
        centerSelect.value = "";

        options.forEach(opt => {
            // Always show the placeholder
            if (opt.value === "") {
                opt.text = deptId ? "Select Service Center" : "Select Department First";
                opt.hidden = false;
                opt.style.display = "";
                return;
            }

            const dataDept = opt.getAttribute('data-dept');

            // Loose comparison in case types differ (string vs int)
            if (deptId && dataDept == deptId) {
                opt.hidden = false;
                opt.style.display = "";
                opt.disabled = false;
            } else {
                opt.hidden = true;
                opt.style.display = "none";
                opt.disabled = true;
            }
        });
    }
    // Set min date to today
    document.querySelector('input[name="date"]').min = new Date().toISOString().split("T")[0];
</script>
{% endblock %}