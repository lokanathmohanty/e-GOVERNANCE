{% extends 'base_bootstrap.html' %}
{% block title %}Book Appointment | e-Gov{% endblock %}
{% block sidebar_mobile %}
<div class="mb-4">
    <div class="text-uppercase text-muted fw-black mb-2 tracking-widest" style="font-size: 10px;">Citizen Hub</div>
    <nav class="nav flex-column gap-1">
        <a class="nav-link rounded-3 d-flex align-items-center gap-3 py-3" href="{% url 'citizen:dashboard' %}">
            <i class="bi bi-speedometer2 text-primary"></i> <span>Dashboard</span>
        </a>
        <a class="nav-link rounded-3 d-flex align-items-center gap-3 py-3" href="{% url 'citizen:services' %}">
            <i class="bi bi-grid-fill text-primary"></i> <span>Service Portal</span>
        </a>
        <a class="nav-link rounded-3 d-flex align-items-center gap-3 py-3" href="{% url 'citizen:locker' %}">
            <i class="bi bi-safe2 text-primary"></i> <span>Digital Locker</span>
        </a>
        <a class="nav-link rounded-3 d-flex align-items-center gap-3 py-3" href="{% url 'citizen:grievances' %}">
            <i class="bi bi-megaphone text-primary"></i> <span>Grievance Box</span>
        </a>
        <a class="nav-link rounded-3 d-flex align-items-center gap-3 py-3 active"
            href="{% url 'citizen:appointments' %}">
            <i class="bi bi-calendar-event text-primary"></i> <span>My Visits</span>
        </a>
    </nav>
</div>
<div class="border-top my-3"></div>
{% endblock %}
{% block content %}
<div class="row justify-content-center py-5 reveal">
    <div class="col-lg-8">
        <div class="card card-premium shadow-premium border-0 overflow-hidden">
            <div class="card-header bg-primary text-white p-5 border-0 position-relative overflow-hidden">
                <div class="position-absolute top-0 end-0 p-4 opacity-10">
                    <i class="bi bi-calendar-check" style="font-size: 8rem;"></i>
                </div>
                <div class="relative z-10">
                    <h2 class="mb-2 fw-black tracking-tight uppercase">Visit Scheduler</h2>
                    <p class="mb-0 opacity-75 font-medium">Reserve a priority slot at your local government service
                        center.</p>
                </div>
            </div>
            <div class="card-body p-5 bg-white">
                <form method="POST" class="space-y-6">
                    {% csrf_token %}
                    <div class="row g-4">
                        <div class="col-md-6">
                            <label class="form-premium-label">Division / Department</label>
                            <div class="position-relative">
                                <select name="department" id="deptSelect" class="form-premium-control appearance-none"
                                    required onchange="filterCenters()">
                                    <option value="">Select Department</option>
                                    {% for d in departments %}
                                    <option value="{{ d.id }}">{{ d.department_name }}</option>
                                    {% endfor %}
                                </select>
                                <i
                                    class="bi bi-chevron-down position-absolute top-50 end-0 translate-middle-y me-3 text-muted pointer-events-none"></i>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <label class="form-premium-label">Service Center</label>
                            <div class="position-relative">
                                <select name="center" id="centerSelect" class="form-premium-control appearance-none"
                                    required>
                                    <option value="" selected disabled>Select Department First</option>
                                    {% for c in centers %}
                                    <option value="{{ c.id }}" data-dept="{{ c.department_id }}">{{ c.name }}</option>
                                    {% endfor %}
                                </select>
                                <i
                                    class="bi bi-geo-alt position-absolute top-50 end-0 translate-middle-y me-3 text-muted pointer-events-none"></i>
                            </div>
                        </div>

                        <div class="col-12">
                            <label class="form-premium-label">Select Service (Optional)</label>
                            <div class="position-relative">
                                <select name="service" id="serviceSelect" class="form-premium-control appearance-none">
                                    <option value="">General Inquiry / Guidance</option>
                                    {% for s in services %}
                                    <option value="{{ s.id }}" data-dept="{{ s.department_id }}">{{ s.service_name }}
                                    </option>
                                    {% endfor %}
                                </select>
                                <i
                                    class="bi bi-chevron-down position-absolute top-50 end-0 translate-middle-y me-3 text-muted pointer-events-none"></i>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <label class="form-premium-label">Appointment Date</label>
                            <div class="position-relative">
                                <input type="date" name="date" class="form-premium-control" required>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <label class="form-premium-label">Available Time Slots</label>
                            <div class="position-relative">
                                <select name="time_slot" class="form-premium-control appearance-none" required>
                                    <option value="">Select Time Slot</option>
                                    {% for slot in time_slots %}
                                    <option value="{{ slot }}">{{ slot }}</option>
                                    {% endfor %}
                                </select>
                                <i
                                    class="bi bi-clock position-absolute top-50 end-0 translate-middle-y me-3 text-muted pointer-events-none"></i>
                            </div>
                        </div>

                        <div class="col-12 mt-3">
                            <div class="card bg-light border-0 p-3 rounded-4">
                                <label class="form-premium-label mb-2">Booking Priority</label>
                                <div class="d-flex gap-4">
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="priority" id="priorityNormal"
                                            value="normal" checked>
                                        <label class="form-check-label fw-bold" for="priorityNormal">
                                            Normal Slot
                                        </label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="priority" id="priorityHigh"
                                            value="priority">
                                        <label class="form-check-label fw-bold text-primary" for="priorityHigh">
                                            Priority / Fast-Track <span class="badge bg-primary ms-1">Express</span>
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="pt-4">
                        <button type="submit" id="submitBtn"
                            class="btn-premium btn-premium-primary w-100 py-4 shadow-lg uppercase tracking-widest fw-black">
                            Confirm Secure Booking
                        </button>
                        <p class="text-center text-muted small mt-4">
                            <i class="bi bi-info-circle"></i> Please arrive 15 minutes before your scheduled slot with
                            valid ID proof.
                        </p>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
    function filterCenters() {
        const deptId = document.getElementById('deptSelect').value;
        const centerSelect = document.getElementById('centerSelect');
        const serviceSelect = document.getElementById('serviceSelect');

        // Reset center select
        centerSelect.value = "";
        const centerOptions = Array.from(centerSelect.querySelectorAll('option'));
        let centerCount = 0;

        centerOptions.forEach(opt => {
            if (opt.value === "") {
                opt.text = deptId ? "--- Now Select a Center ---" : "Select Department First";
                return;
            }

            const optDept = opt.getAttribute('data-dept');
            if (deptId && optDept === deptId) {
                opt.hidden = false;
                opt.disabled = false;
                centerCount++;
            } else {
                opt.hidden = true;
                opt.disabled = true;
            }
        });

        if (deptId && centerCount === 0) {
            const placeholder = centerOptions.find(o => o.value === "");
            if (placeholder) placeholder.text = "No centers available for this department";
        }

        // Also filter services
        const svcOptions = Array.from(serviceSelect.querySelectorAll('option'));
        svcOptions.forEach(opt => {
            if (opt.value === "") return;
            const optDept = opt.getAttribute('data-dept');
            if (deptId && optDept === deptId) {
                opt.hidden = false;
                opt.disabled = false;
            } else {
                opt.hidden = true;
                opt.disabled = true;
            }
        });
    }

    document.addEventListener('DOMContentLoaded', () => {
        // Init date picker min
        const dateInput = document.querySelector('input[name="date"]');
        if (dateInput) {
            const today = new Date().toISOString().split('T')[0];
            dateInput.min = today;
        }

        // Ensure filter runs if dept is pre-selected
        if (document.getElementById('deptSelect').value) {
            filterCenters();
        }
    });

    // Handle form validation visual feedback
    document.querySelector('form').addEventListener('submit', function (e) {
        const btn = document.getElementById('submitBtn');
        btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Processing...';
        // Note: Don't disable immediately if you want browser validation to work
    });
</script>
{% endblock %}