{% extends 'base_bootstrap.html' %}
{% load static %}

{% block title %}Citizen Dashboard | e-Gov Portal{% endblock %}
{% block content %}
<div class="container-fluid bg-light min-vh-100 py-4">
    <div class="container">
        <!-- Welcome Header -->
        <div class="row mb-4">
            <div class="col-md-8">
                <h2 class="mb-2">Welcome back, {{ user.first_name|default:user.username }}</h2>
                <p class="text-muted">Manage your applications and certificates from a single dashboard.</p>
            </div>
            <div class="col-md-4 text-md-end">
                <a href="{% url 'citizen:id_card' %}" class="btn btn-primary btn-sm me-2">
                    <i class="bi bi-person-badge"></i> ID Card
                </a>
                <button class="btn btn-outline-primary btn-sm" data-bs-toggle="modal" data-bs-target="#helpModal">
                    <i class="bi bi-question-circle"></i> Need help?
                </button>
            </div>
        </div>

        <!-- Stats Cards -->
        <div class="row g-2 mb-4 stagger-container">
            <div class="col-6 col-md-2 stagger-item">
                <div class="card border-start border-secondary border-3 h-100">
                    <div class="card-body p-3">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <p class="text-muted small mb-1">Total</p>
                                <h3 class="mb-0 count-up" data-value="{{ stats.total }}">0</h3>
                            </div>
                            <i class="bi bi-folder text-secondary fs-3 d-none d-lg-block"></i>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-6 col-md-2 stagger-item">
                <div class="card border-start border-warning border-3 h-100">
                    <div class="card-body p-3">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <p class="text-muted small mb-1">In Progress</p>
                                <h3 class="mb-0 count-up" data-value="{{ stats.in_progress }}">0</h3>
                            </div>
                            <i class="bi bi-clock-history text-warning fs-3 d-none d-lg-block"></i>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-6 col-md-2 stagger-item">
                <div class="card border-start border-success border-3 h-100">
                    <div class="card-body p-3">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <p class="text-muted small mb-1">Approved</p>
                                <h3 class="mb-0 count-up" data-value="{{ stats.approved }}">0</h3>
                            </div>
                            <i class="bi bi-check-circle text-success fs-3 d-none d-lg-block"></i>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-6 col-md-2 stagger-item">
                <div class="card border-start border-danger border-3 h-100">
                    <div class="card-body p-3">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <p class="text-muted small mb-1">Rejected</p>
                                <h3 class="mb-0 count-up" data-value="{{ stats.rejected }}">0</h3>
                            </div>
                            <i class="bi bi-x-circle text-danger fs-3 d-none d-lg-block"></i>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-6 col-md-2 stagger-item">
                <div class="card border-start border-warning border-3 bg-warning bg-opacity-10 h-100">
                    <div class="card-body p-3">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <p class="text-muted small mb-1">Delayed</p>
                                <h3 class="mb-0 count-up" data-value="{{ stats.delayed }}">0</h3>
                            </div>
                            <i class="bi bi-exclamation-triangle text-warning fs-3 d-none d-lg-block"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Quick Actions & Community -->
        <!-- Main Content Card -->
        <div class="card shadow-sm">
            <!-- Tabs and Action Button -->
            <div class="card-header bg-white border-bottom">
                <div class="d-flex justify-content-between align-items-center">
                    <ul class="nav nav-tabs card-header-tabs" role="tablist">
                        <li class="nav-item">
                            <a class="nav-link active" data-bs-toggle="tab" href="#all-apps">
                                <i class="bi bi-grid"></i> All Applications
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" data-bs-toggle="tab" href="#certificates">
                                <i class="bi bi-download"></i> Downloads & Certificates
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" data-bs-toggle="tab" href="#history">
                                <i class="bi bi-clock-history"></i> History
                            </a>
                        </li>
                    </ul>
                    <a href="{% url 'citizen:services' %}" class="btn btn-primary">
                        <i class="bi bi-plus-circle"></i> Apply for New Service
                    </a>
                </div>
            </div>

            <!-- Filters -->
            <div class="card-body border-bottom bg-light">
                <div class="row g-2">
                    <div class="col-md-4 search-bar-container">
                        <input type="text" class="form-control search-bar-pill"
                            placeholder="Search by App ID or Service Name" id="searchInput">
                    </div>
                    <div class="col-md-3">
                        <select class="form-select" id="statusFilter">
                            <option value="">Status: All</option>
                            <option value="pending">Pending</option>
                            <option value="under_review">In Progress</option>
                            <option value="approved">Approved</option>
                            <option value="rejected">Rejected</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <select class="form-select" id="deptFilter">
                            <option value="">Dept: All</option>
                            {% for dept in departments %}
                            <option value="{{ dept.id }}">{{ dept.department_name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
            </div>

            <!-- Applications Table -->
            <div class="card-body p-0">
                <div class="tab-content">
                    <div class="tab-pane fade show active" id="all-apps">
                        <div class="table-responsive-card">
                            <table class="table table-hover mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th>APPLICATION ID</th>
                                        <th>SERVICE NAME</th>
                                        <th>DEPARTMENT</th>
                                        <th>PRIORITY</th>
                                        <th>STATUS</th>
                                        <th>APPLIED DATE</th>
                                        <th>SLA STATE</th>
                                        <th class="text-end">ACTIONS</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for app in applications %}
                                    <tr>
                                        <td data-label="App ID" class="text-muted small">#{{ app.application_number }}
                                        </td>
                                        <td data-label="Service" class="fw-bold">{{ app.service.service_name }}</td>
                                        <td data-label="Dept" class="text-muted">{{
                                            app.service.department.department_name }}</td>
                                        <td data-label="Priority">
                                            {% if app.priority == 'disaster' %}
                                            <span class="badge bg-danger"><i class="bi bi-lightning-fill"></i>
                                                Emergency</span>
                                            {% elif app.priority == 'emergency' %}
                                            <span class="badge bg-warning text-dark"><i
                                                    class="bi bi-exclamation-triangle"></i> Urgent</span>
                                            {% else %}
                                            <span class="badge bg-secondary">Normal</span>
                                            {% endif %}
                                        </td>
                                        <td data-label="Status">
                                            {% if app.status == 'approved' %}
                                            <span class="badge bg-success">Approved</span>
                                            {% elif app.status == 'rejected' %}
                                            <span class="badge bg-danger">Rejected</span>
                                            {% elif app.status == 'under_review' %}
                                            <span class="badge bg-info">In Progress</span>
                                            {% elif app.status == 'draft' %}
                                            <span class="badge bg-secondary border">Draft</span>
                                            {% else %}
                                            <span class="badge bg-warning text-dark">Pending</span>
                                            {% endif %}
                                        </td>
                                        <td data-label="Applied On" class="text-muted">{{ app.applied_date|date:"M d, Y"
                                            }}</td>
                                        <td data-label="SLA">
                                            {% if app.sla_status == 'on_time' %}
                                            <span class="text-success small fw-bold"><i class="bi bi-circle-fill"></i>
                                                On Track</span>
                                            {% elif app.sla_status == 'near_deadline' %}
                                            <span class="text-warning small fw-bold"><i class="bi bi-circle-fill"></i>
                                                Near Deadline</span>
                                            {% elif app.sla_status == 'delayed' %}
                                            <span class="text-danger small fw-bold"><i class="bi bi-circle-fill"></i>
                                                Overdue</span>
                                            {% else %}
                                            <span class="text-success small fw-bold"><i
                                                    class="bi bi-check-circle-fill"></i> Completed</span>
                                            {% endif %}
                                        </td>
                                        <td class="text-end">
                                            <div class="d-flex justify-content-end gap-1">
                                                {% if app.status == 'draft' %}
                                                <a href="{% url 'citizen:apply' app.service.id %}?resume={{ app.id }}"
                                                    class="btn btn-sm btn-primary fw-bold px-3">
                                                    <i class="bi bi-play-circle-fill"></i> Resume
                                                </a>
                                                {% else %}
                                                <a href="{% url 'citizen:detail' app.id %}"
                                                    class="btn btn-sm btn-light border">
                                                    <i class="bi bi-eye"></i>
                                                </a>
                                                {% if app.status == 'approved' %}
                                                <a href="{% url 'citizen:certificate' app.id %}"
                                                    class="btn btn-sm btn-success" target="_blank">
                                                    <i class="bi bi-download"></i>
                                                </a>
                                                {% endif %}
                                                {% endif %}
                                            </div>
                                        </td>
                                    </tr>
                                    {% empty %}
                                    <tr>
                                        <td colspan="8" class="text-center py-5 text-muted">
                                            <i class="bi bi-inbox fs-1 d-block mb-3"></i>
                                            <p>No applications yet</p>
                                            <a href="{% url 'citizen:services' %}" class="btn btn-primary btn-sm">Apply
                                                for Your First Service</a>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        {% if applications %}
                        <div class="card-footer bg-light">
                            <small class="text-muted">Showing 1-{{ applications|length }} of {{ stats.total }}
                                applications</small>
                        </div>
                        {% endif %}
                    </div>

                    <div class="tab-pane fade" id="certificates">
                        <div class="p-4">
                            <h5 class="mb-3"><i class="bi bi-award text-success"></i> Available Certificates</h5>
                            <p class="text-muted small mb-4">Download your approved certificates below. Click the button
                                to view and print your certificate.</p>
                            {% for app in approved_apps %}
                            <div class="card mb-3 border-success">
                                <div class="card-body d-flex justify-content-between align-items-center">
                                    <div>
                                        <h6 class="mb-1 text-success">
                                            <i class="bi bi-check-circle-fill"></i>
                                            {{ app.service.service_name }}
                                        </h6>
                                        <small class="text-muted">
                                            #{{ app.application_number }} â€¢
                                            Approved on {{ app.approved_date|date:"M d, Y" }} â€¢
                                            {{ app.service.department.department_name }}
                                        </small>
                                    </div>
                                    <a href="{% url 'citizen:certificate' app.id %}" class="btn btn-success"
                                        target="_blank">
                                        <i class="bi bi-download"></i> Download Certificate
                                    </a>
                                </div>
                            </div>
                            {% empty %}
                            <div class="text-center py-5">
                                <i class="bi bi-award fs-1 text-muted d-block mb-3"></i>
                                <p class="text-muted">No certificates available yet.</p>
                                <p class="small text-muted">Once your applications are approved, you can download
                                    certificates here.</p>
                            </div>
                            {% endfor %}
                        </div>
                    </div>

                    <div class="tab-pane fade" id="history">
                        <div class="p-4">
                            <p class="text-muted">Application history will be displayed here</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Info Box -->
        <div class="alert alert-info mt-4">
            <i class="bi bi-info-circle-fill"></i> <strong>Did you know?</strong>
            You can now download digitally signed certificates directly from the "Downloads & Certificates" tab without
            visiting the office.
        </div>

        <!-- Dashboard Widgets Grid -->
        <div class="row g-4 mb-5">
            <!-- Left Column: Quick Actions & Appointments -->
            <div class="col-lg-8">
                <!-- Quick Actions Grid -->
                <div class="d-flex align-items-center justify-content-between mb-3">
                    <h5 class="fw-bold text-dark mb-0">ðŸš€ Quick Actions</h5>
                </div>
                <div class="row g-3 mb-4 stagger-container">
                    <div class="col-md-6 stagger-item">
                        <a href="{% url 'citizen:book_appointment' %}"
                            class="card h-100 border-0 shadow-sm hover-lift text-decoration-none">
                            <div class="card-body d-flex align-items-center gap-3">
                                <div class="bg-primary bg-opacity-10 p-3 rounded-4 text-primary">
                                    <i class="bi bi-calendar-event fs-4"></i>
                                </div>
                                <div>
                                    <h6 class="fw-bold text-dark mb-1">Book Appointment</h6>
                                    <small class="text-muted">Schedule a visit to center</small>
                                </div>
                            </div>
                        </a>
                    </div>
                    <div class="col-md-6 stagger-item">
                        <a href="{% url 'citizen:family' %}"
                            class="card h-100 border-0 shadow-sm hover-lift text-decoration-none">
                            <div class="card-body d-flex align-items-center gap-3">
                                <div class="bg-success bg-opacity-10 p-3 rounded-4 text-success">
                                    <i class="bi bi-people fs-4"></i>
                                </div>
                                <div>
                                    <h6 class="fw-bold text-dark mb-1">Family Profile</h6>
                                    <small class="text-muted">Manage household members</small>
                                </div>
                            </div>
                        </a>
                    </div>
                    <div class="col-md-6 stagger-item">
                        <button onclick="new bootstrap.Modal('#eligibilityModal').show()"
                            class="card h-100 border-0 shadow-sm hover-lift text-decoration-none w-100 text-start">
                            <div class="card-body d-flex align-items-center gap-3">
                                <div class="bg-warning bg-opacity-10 p-3 rounded-4 text-warning">
                                    <i class="bi bi-magic fs-4"></i>
                                </div>
                                <div>
                                    <h6 class="fw-bold text-dark mb-1">Check Eligibility</h6>
                                    <small class="text-muted">Find relevant schemes</small>
                                </div>
                            </div>
                        </button>
                    </div>
                    <div class="col-md-6 stagger-item">
                        <a href="{% url 'citizen:security' %}"
                            class="card h-100 border-0 shadow-sm hover-lift text-decoration-none">
                            <div class="card-body d-flex align-items-center gap-3">
                                <div class="bg-secondary bg-opacity-10 p-3 rounded-4 text-secondary">
                                    <i class="bi bi-shield-lock fs-4"></i>
                                </div>
                                <div>
                                    <h6 class="fw-bold text-dark mb-1">Security Center</h6>
                                    <small class="text-muted">Login history & privacy</small>
                                </div>
                            </div>
                        </a>
                    </div>
                </div>

                <!-- Upcoming Appointments -->
                <div class="card border-0 shadow-sm rounded-4 overflow-hidden mb-4 mb-lg-0">
                    <div
                        class="card-header bg-white border-bottom border-light py-3 px-4 d-flex justify-content-between align-items-center">
                        <h6 class="fw-bold mb-0">ðŸ“… Upcoming Appointments</h6>
                        <a href="{% url 'citizen:appointments' %}" class="text-decoration-none small fw-bold">View
                            All</a>
                    </div>
                    <div class="list-group list-group-flush">
                        {% if upcoming_appointments %}
                        {% for appt in upcoming_appointments %}
                        <div class="list-group-item px-4 py-3 border-light">
                            <div class="d-flex align-items-center">
                                <div class="flex-shrink-0 text-center bg-light rounded-3 p-2 me-3"
                                    style="min-width: 60px;">
                                    <div class="fw-bold text-dark h5 mb-0">{{ appt.date|date:"d" }}</div>
                                    <small class="text-uppercase text-muted" style="font-size: 10px;">{{
                                        appt.date|date:"M" }}</small>
                                </div>
                                <div class="flex-grow-1">
                                    <h6 class="mb-1 fw-bold text-dark">{{ appt.department_center.name }}</h6>
                                    <div class="d-flex align-items-center gap-2 text-muted small">
                                        <span><i class="bi bi-clock me-1"></i>{{ appt.time_slot }}</span>
                                        <span
                                            class="badge bg-success-subtle text-success rounded-pill px-2">Confirmed</span>
                                    </div>
                                </div>
                                <div class="ms-3">
                                    <a href="#" class="btn btn-sm btn-light rounded-circle"><i
                                            class="bi bi-chevron-right"></i></a>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                        {% else %}
                        <div class="p-5 text-center">
                            <div class="mb-3 text-muted opacity-50"><i class="bi bi-calendar-x fs-1"></i></div>
                            <h6 class="text-muted fw-normal">No upcoming appointments</h6>
                            <a href="{% url 'citizen:book_appointment' %}"
                                class="btn btn-sm btn-primary mt-2 rounded-pill px-4">Book Now</a>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Right Column: Community & Alerts -->
            <div class="col-lg-4">
                <!-- Poll Widget -->
                <div class="card border-0 shadow-sm rounded-4 mb-4 text-white overflow-hidden position-relative"
                    style="background: linear-gradient(135deg, #6366F1 0%, #8B5CF6 100%); min-height: 200px;">
                    <!-- Removed overlap icon -->
                    <div class="card-body p-4 position-relative z-1">
                        {% if active_poll %}
                        <span class="badge bg-white bg-opacity-25 mb-3 border border-white border-opacity-25">COMMUNITY
                            POLL</span>
                        <h5 class="fw-bold mb-4 text-white" style="text-shadow: 0 2px 4px rgba(0,0,0,0.1);">{{
                            active_poll.question }}</h5>

                        {% if has_voted %}
                        <div class="bg-white p-4 rounded-4 shadow-sm text-center">
                            <i class="bi bi-check-circle-fill fs-1 mb-2 d-block text-success"></i>
                            <span class="fw-bold text-dark h5 d-block mb-1">Thanks for voting!</span>
                            <small class="text-muted">Your opinion matters.</small>
                        </div>
                        {% else %}
                        <form action="{% url 'citizen:vote_poll' active_poll.id %}" method="POST">
                            {% csrf_token %}
                            <div class="d-grid gap-2">
                                {% for opt in active_poll.options.all %}
                                <button type="submit" name="option" value="{{ opt.id }}"
                                    class="btn btn-white border-0 text-primary fw-bold text-start px-3 py-3 shadow-sm rounded-3 hover-scale">
                                    {{ opt.text }}
                                </button>
                                {% endfor %}
                            </div>
                        </form>
                        {% endif %}
                        {% else %}
                        <div class="text-center py-4 text-white text-opacity-75">
                            <i class="bi bi-chat-square-quote fs-1"></i>
                            <p class="mt-2 text-white">No active polls today.</p>
                        </div>
                        {% endif %}
                    </div>
                </div>

                <!-- Smart Reminders -->
                <div class="card border-0 shadow-sm rounded-4">
                    <div class="card-header bg-white border-0 py-3 px-4">
                        <h6 class="fw-bold mb-0 text-dark"><i class="bi bi-bell-fill text-warning me-2"></i>Expiry
                            Alerts</h6>
                    </div>
                    <div class="card-body px-4 pb-4 pt-0">
                        {% if reminders %}
                        {% for doc in reminders %}
                        <div
                            class="d-flex align-items-center p-3 rounded-3 bg-warning bg-opacity-10 mb-2 border border-warning border-opacity-25">
                            <div class="flex-shrink-0 text-warning">
                                <i class="bi bi-exclamation-triangle-fill fs-4"></i>
                            </div>
                            <div class="ms-3 flex-grow-1">
                                <h6 class="mb-0 fw-bold text-dark">{{ doc.document_name }}</h6>
                                <small class="text-danger fw-bold">Expires: {{ doc.expiry_date|date:"M d, Y" }}</small>
                            </div>
                        </div>
                        {% endfor %}
                        <div class="text-center mt-3">
                            <a href="#" class="small text-decoration-none fw-bold">View Locker <i
                                    class="bi bi-arrow-right"></i></a>
                        </div>
                        {% else %}
                        <div class="text-center py-4">
                            <div class="d-inline-flex bg-success bg-opacity-10 p-3 rounded-circle text-success mb-3">
                                <i class="bi bi-shield-check fs-2"></i>
                            </div>
                            <p class="text-muted mb-0 small">All your documents are valid and up to date.</p>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>


    </div>

</div>


<script>
    // Client-side filtering
    document.getElementById('searchInput').addEventListener('keyup', filterTable);
    document.getElementById('statusFilter').addEventListener('change', filterTable);
    document.getElementById('deptFilter').addEventListener('change', filterTable);

    function filterTable() {
        const search = document.getElementById('searchInput').value.toLowerCase();
        const status = document.getElementById('statusFilter').value.toLowerCase();
        const dept = document.getElementById('deptFilter').value;

        const rows = document.querySelectorAll('tbody tr');
        rows.forEach(row => {
            const text = row.textContent.toLowerCase();
            const matchSearch = text.includes(search);
            const matchStatus = !status || text.includes(status);

            if (matchSearch && matchStatus) {
                row.style.display = '';
            } else {
                row.style.display = 'none';
            }
        });
    }
</script>

<!-- Eligibility Modal -->
<div class="modal fade" id="eligibilityModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content rounded-4 border-0">
            <div class="modal-header bg-warning bg-opacity-10 border-0">
                <h5 class="modal-title fw-bold text-dark"><i class="bi bi-magic fs-4 me-2"></i> Eligibility Wizard</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-4">
                <div class="row" id="wizardQuestions">
                    <div class="col-md-6 mb-3">
                        <label class="form-label fw-bold">Annual Family Income</label>
                        <select class="form-select border-2" id="eliIncome">
                            <option value="low">Less than â‚¹2.5 Lakhs</option>
                            <option value="mid">â‚¹2.5 Lakhs - â‚¹8 Lakhs</option>
                            <option value="high">Above â‚¹8 Lakhs</option>
                        </select>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label fw-bold">Occupation / Status</label>
                        <select class="form-select border-2" id="eliStatus">
                            <option value="student">Student</option>
                            <option value="farmer">Farmer</option>
                            <option value="senior">Senior Citizen</option>
                            <option value="employed">Private Employee</option>
                            <option value="unemployed">Unemployed</option>
                        </select>
                    </div>
                </div>

                <div id="eliResult" class="alert alert-success mt-3 d-none border-0 bg-success bg-opacity-10">
                    <h6 class="fw-bold text-success mb-2"><i class="bi bi-check-circle-fill"></i> Recommended Schemes:
                    </h6>
                    <ul class="mb-0 small" id="eliList"></ul>
                </div>
            </div>
            <div class="modal-footer border-0">
                <button onclick="checkEligibility()" class="btn btn-warning text-dark fw-bold rounded-pill px-4">Check
                    Eligibility</button>
            </div>
        </div>
    </div>
</div>

<script>
    function checkEligibility() {
        const income = document.getElementById('eliIncome').value;
        const status = document.getElementById('eliStatus').value;
        const list = document.getElementById('eliList');
        const result = document.getElementById('eliResult');

        list.innerHTML = '';
        const schemes = [];

        // Logic (Dummy AI)
        if (status === 'student') schemes.push("Post-Matric Scholarship", "Free Laptop Scheme");
        if (status === 'farmer') schemes.push("Kisan Samman Nidhi", "Crop Insurance Subsidy");
        if (status === 'senior') schemes.push("Old Age Pension", "Senior Citizen Travel Concession");
        if (income === 'low') schemes.push("Ration Card Priority", "Housing Subsidy (PMAY)");
        if (status === 'unemployed') schemes.push("Skill Development Training", "Unemployment Allowance");

        if (schemes.length > 0) {
            schemes.forEach(s => {
                const li = document.createElement('li');
                li.textContent = s;
                list.appendChild(li);
            });
            result.classList.remove('d-none');
        } else {
            list.innerHTML = '<li>General Citizen Services</li>';
            result.classList.remove('d-none');
        }
    }

    // Count-up animation
    function animateValue(obj, start, end, duration) {
        let startTimestamp = null;
        const step = (timestamp) => {
            if (!startTimestamp) startTimestamp = timestamp;
            const progress = Math.min((timestamp - startTimestamp) / duration, 1);
            obj.innerHTML = Math.floor(progress * (end - start) + start);
            if (progress < 1) {
                window.requestAnimationFrame(step);
            }
        };
        window.requestAnimationFrame(step);
    }

    document.addEventListener('DOMContentLoaded', () => {
        const counters = document.querySelectorAll('.count-up');
        setTimeout(() => {
            counters.forEach(counter => {
                const target = parseInt(counter.dataset.value);
                if (!isNaN(target)) {
                    animateValue(counter, 0, target, 1500);
                }
            });
        }, 500);
    });
</script>
{% endblock %}